% !TeX root = ../tfg.tex
% !TeX encoding = utf8

\chapter{Detalles Matemáticos Adicionales}\label{ap:apendiceA}

En este apéndice se muestran las demostraciones del Lema~\ref{lema:raro-clasificación-gd}, extraída de~\cite{Soudry2024}, y de la Proposición~\ref{prop:non-conexity}.

\textbf{Lema}~\ref{lema:raro-clasificación-gd}. Sea $\mathcal{L}(w)$ una función $\beta$-suave no negativa. Si $\eta < \frac{2}{\beta}$, entonces, para cualquier $w_0$ y utilizando el método del descenso de gradiente dado por:

\[
    w^{(\tau + 1)} = w^{(\tau)} - \eta \nabla \mathcal{L}(w),
\]

se tiene que $\sum_{u=0}^{\infty} \| \nabla\mathcal{L}(w^{(u)}) \|^{2} < \infty$ y, por tanto:

\[
    \lim \limits_{t \to \infty} \| \nabla\mathcal{L}(w^{(t)}) \|^{2} = 0.
\]

\begin{proof}
  Usaremos una propiedad conocida de las funciones $\beta$-suaves:

  \[
      | f(x) - f(y) - \nabla f(y)^{T} (x-y) | \leq \| x - y \|^2.
  \]  

  Dado que la función $\mathcal{L}(w)$ es $\beta$-suave:

  \begin{align}
      \mathcal{L} (w^{(\tau + 1)}) &\leq \mathcal{L} (w^{(\tau)}) + \nabla \mathcal{L} (w^{\tau})^{T} (w^{(\tau + 1)} - w^{\tau}) + \frac{\beta}{2} \|w^{(\tau + 1)} - w^{(\tau)}\|^2 \notag \\
      &= \mathcal{L} (w^{(\tau)}) - \eta \|\nabla \mathcal{L} (w^{(\tau)})\|^2 + \frac{\beta \eta^2}{2} \|\nabla \mathcal{L} (w^{(\tau)})\|^2 \notag \\
      &= \mathcal{L} (w^{(\tau)}) - \eta \left( 1 - \frac{\beta \eta}{2} \right) \|\nabla \mathcal{L} (w^{(\tau)})\|^2.
  \end{align}

  Así, tenemos:

  \[
      \frac{\mathcal{L} (w^{(\tau)}) - \mathcal{L} (w^{(\tau + 1)})}{\eta \left( 1 - \frac{\beta \eta}{2} \right)} \geq \|\nabla \mathcal{L} (w^{(\tau)})\|^2,
  \]

  lo que implica que

  \[
      \sum_{u=0}^{t} \|\nabla \mathcal{L} (w^{(u)})\|^2 \leq \sum_{u=0}^{t} \frac{\mathcal{L} (w^{(u)}) - \mathcal{L} (w^{(u+1)})}{\eta \left( 1 - \frac{\beta \eta}{2} \right)} = \frac{\mathcal{L} (w_0) - \mathcal{L} (w^{(\tau + 1)})}{\eta \left( 1 - \frac{\beta \eta}{2} \right)}.
  \]

  El lado derecho está acotado por una constante finita, dado que $\mathcal{L} (w_0) < \infty$ y $0 \leq \mathcal{L} (w^{(\tau + 1)})$. Por tanto, se deduce que

  \[
      \sum_{u=0}^{\infty} \|\nabla \mathcal{L} (w^{(u)})\|^2 < \infty,
  \]

  y, finalmente, nos queda el resultado buscado: $\|\nabla \mathcal{L} (w^{(\tau)})\|^2 \to 0$.
\end{proof}

\textbf{Proposición}~\ref{prop:non-conexity}. Sea $w^{*}$ una solución, es decir, $\mathcal{L}(w^{*}) = 0$, y supongamos que $\frac{d}{dw}\frac{\partial \mathcal{L}}{\partial \mathcal{F}}(w^{*}) \neq 0$ y $rang(H_{\mathcal{F}_{i}}(w^{*})) > 2n$ para algún $i \in \{1, \ldots, n \}$. Entonces, $\mathcal{L}(w)$ no es convexa en ningún entorno de $w^{*}$.

\begin{proof}
    La matriz Hessiana de una función de pérdida $\mathcal{L}(\mathcal{F}(w))$ viene dada por:

    \[
        H_{\mathcal{L}}(w) = \mathcal{DF}(w)^T \frac{\partial^2 \mathcal{L}}{\partial \mathcal{F}^2}(w) \mathcal{DF}(w) + \sum_{i=1}^{n} \frac{\partial \mathcal{L}}{\partial \mathcal{F}_i}(w) H_{\mathcal{F}_i}(w).
    \]

    Consideramos ahora las matrices Hessianas de dos puntos $w^* + \delta $ y $w^* - \delta $ $(\delta \in \mathbb{R}^{P})$ que están en un entorno suficientemente pequeño de $w^*$. La Hessiana de la función de pérdida en estos dos puntos es:

    \begin{equation}\label{eq:non-convexity1}
        \begin{aligned}
            H_{\mathcal{L}}( w^* + \delta) &=  
            \underbrace{\mathcal{DF}( w^* + \delta)^T \frac{\partial^2 \mathcal{L}}{\partial \mathcal{F}^2}( w^* + \delta) \mathcal{DF}( w^* + \delta)}_{A( w^* + \delta)} \\
            &\quad + \sum_{i=1}^{n} \left( \frac{d}{d w} \left( \frac{\partial \mathcal{L}}{\partial \mathcal{F}}( w^*) \right) \delta \right)_i H_{\mathcal{F}_i}( w^* + \delta) + o(\|\delta\|),
        \end{aligned}
    \end{equation}
        
    \begin{align}
        H_{\mathcal{L}}( w^* - \delta) &=  
        \underbrace{\mathcal{DF}( w^* - \delta)^T \frac{\partial^2 \mathcal{L}}{\partial \mathcal{F}^2}( w^* - \delta) \mathcal{DF}( w^* - \delta)}_{A( w^* - \delta)} \nonumber \\
        &\quad - \sum_{i=1}^{n} \left( \frac{d}{d w} \left( \frac{\partial \mathcal{L}}{\partial \mathcal{F}}( w^*) \right) \delta \right)_i H_{\mathcal{F}_i}( w^* + \delta) + o(\|\delta\|),
    \end{align}
        

    donde los términos $ A( w^* + \delta) $ y $ A( w^* - \delta) $ son matrices de rango a lo sumo $ n $, ya que $ \mathcal{DF} $ es de tamaño $ n \times m $ ($o(\|\delta\|)$ representa un término asintóticamente menor que $\| \delta \|$).

    Sabemos que al menos un componente $ H_{\mathcal{F}_k} $ de la matriz Hessiana de $ \mathcal{F} $ satisface que el rango de $ H_{\mathcal{F}_k}( w^*) $ es mayor que $ 2n $. Por continuidad de la Hessiana, si el orden de $ \delta $ es suficientemente pequeño, entonces los rangos de $ H_{\mathcal{F}_k}( w^* + \delta) $ y $ H_{\mathcal{F}_k}( w^* - \delta) $ también son mayores que $ 2n $. Esto nos lleva a que siempre podemos encontrar un vector unitario $v \in \mathbb{R}^P $ que cumpla:

    \[
        v^T A( w^* + \delta)  v =  v^T A( w^* - \delta)  v = 0.
    \]

    Sin embargo, dicho vector también verifica:

    \[
        v^T H_{\mathcal{F}_k}( w^* + \delta)  v \neq 0, \quad  v^T H_{\mathcal{F}_k}( w^* - \delta)  v \neq 0.
    \]

    De esta manera, el vector $ \langle v^T H_{\mathcal{F}_1}( w^*+\delta)  v, \dots,  v^T H_{\mathcal{F}_n}( w^*+\delta)  v \rangle \neq 0$. El mismo resultado se verifica para el punto $w^* - \delta$. Así, utilizando este vector $v$ en la Hessiana de la función de pérdida en los dos puntos tenemos:

    \begin{align}
        v^T H_{\mathcal{L}}( w^* + \delta)v &=  
        \sum_{i=1}^{n} \left( \frac{d}{d w} \left( \frac{\partial \mathcal{L}}{\partial \mathcal{F}}( w^*) \right) \delta \right)_i v^T H_{\mathcal{F}_i}( w^* + \delta) v + o(\|\delta\|),
    \end{align}

    \begin{align}
        v^T H_{\mathcal{L}}( w^* - \delta)v &=  
        - \sum_{i=1}^{n} \left( \frac{d}{d w} \left( \frac{\partial \mathcal{L}}{\partial \mathcal{F}}( w^*) \right) \delta \right)_i v^T H_{\mathcal{F}_i}( w^* - \delta) v + o(\|\delta\|).
    \end{align}

    Para finalizar tenemos que mostrar que, para un $\delta$ suficientemente pequeño, $v^T H_{\mathcal{L}}(w^* + \delta) v$ y $v^T H_{\mathcal{L}}(w^* - \delta) v$ no pueden ser simultáneamente no negativos, lo que implica inmediatamente que $H_{\mathcal{L}}$ no es semidefinida positiva en un entorno cercano de $w^*$ y, por tanto, $\mathcal{L}$ no es localmente convexa en $w^*$. Usando la condición 
    \[
    \frac{d}{dw} (\frac{\partial \mathcal{L}}{\partial \mathcal{F}}(w^*)) = 0,
    \]
    para las ecuaciones anteriores, se presentan los siguientes casos:

    \textbf{Caso $\boldsymbol{1}$:} Si 
    \[
    \sum_{i=1}^{n} \left( \frac{d}{dw} (\frac{\partial \mathcal{L}}{\partial \mathcal{F}}(w^*))\delta \right)_i v^T H_{\mathcal{F}_i}(w^* + \delta) v < 0,
    \]
    entonces, directamente, $v^T H_{\mathcal{L}}(w^* + \delta) v < 0$ si $\delta$ es lo suficientemente pequeño.

    \textbf{Caso $\boldsymbol{2}$:} De lo contrario, si 
    \[
    \sum_{i=1}^{n} \left( \frac{d}{dw} (\frac{\partial \mathcal{L}}{\partial \mathcal{F}}(w^*))\delta \right)_i v^T H_{\mathcal{F}_i}(w^* + \delta) v > 0,
    \]
    por la continuidad de cada $H_{\mathcal{F}_i}(\cdot)$, tenemos que
    \[
        -\sum_{i=1}^{n} \left( \frac{d}{dw} (\frac{\partial \mathcal{L}}{\partial \mathcal{F}}(w^*))\delta \right)_i v^T H_{\mathcal{F}_i}(w^* - \delta) v
    \]

    \[
        \\ = -\sum_{i=1}^{n} \left( \frac{d}{dw} (\frac{\partial \mathcal{L}}{\partial \mathcal{F}}(w^*))\delta \right)_i v^T H_{\mathcal{F}_i}(w^* + \delta) v + \sum_{i=1}^{n} \left( \frac{d}{dw} (\frac{\partial \mathcal{L}}{\partial \mathcal{F}}(w^*))\delta \right)_i v^T (H_{\mathcal{F}_i}(w^* + \delta) v - \mathcal{H}_{\mathcal{F}_i}(w^* - \delta)) v
    \]

    \[
        \\ = -\sum_{i=1}^{n} \left( \frac{d}{dw} (\frac{\partial \mathcal{L}}{\partial \mathcal{F}}(w^*))\delta \right)_i v^T H_{\mathcal{F}_i}(w^* + \delta) v + O(\epsilon) < 0,
    \]
    
    cuando $\delta$ es lo suficientemente pequeño. A modo de conclusión, dado un $\delta$ arbitrariamente pequeño, se tiene que $v^T H_{\mathcal{L}}(w^* + \delta) v$ o $v^T H_{\mathcal{L}}(w^* - \delta) v$ es negativo, lo que significa que $\mathcal{L}(w)$ no es convexa en ningún entorno de $w^*$.

\end{proof}

\endinput
%------------------------------------------------------------------------------------
% FIN DEL APÉNDICE. 
%------------------------------------------------------------------------------------
